{% extends "base.html" %}

{% block title %}Chat con Docs - AutOCR{% endblock %}

{% block content %}
<div class="row mb-4 animate-fade-in">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 fw-bold"><i class="fas fa-robot me-2 text-info"></i> Chat Documental</h1>
            <p class="text-muted small">Pregunte a su base de conocimiento.</p>
        </div>
        <button id="rebuild-btn" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-sync me-1"></i> Reindexar
        </button>
    </div>
</div>

<div class="row animate-slide-up" style="height: calc(100vh - 200px);">
    <div class="col-12 h-100">
        <div class="card h-100 border-0 shadow-lg d-flex flex-column bg-dark bg-opacity-25">
            <!-- Chat History -->
            <div id="chat-history" class="card-body overflow-auto p-4 custom-scrollbar" style="flex: 1;">
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                    <p>Escriba su consulta para buscar en los documentos procesados.</p>
                    <small>Ej: "Facturas de electricidad de 2024" o "Contrato de alquiler"</small>
                </div>
            </div>

            <!-- Input Area -->
            <div class="card-footer bg-transparent border-top border-secondary border-opacity-25 p-4">
                <form id="chat-form" class="d-flex gap-2">
                    <input type="text" id="user-input" class="form-control bg-dark text-light border-secondary"
                        placeholder="Escriba su pregunta..." autocomplete="off">
                    <button type="submit" class="btn btn-info px-4">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');
        const history = document.getElementById('chat-history');
        const rebuildBtn = document.getElementById('rebuild-btn');

        function appendMessage(role, content, isHtml = false) {
            const div = document.createElement('div');
            div.className = `d-flex mb-4 ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-3 ${role === 'user' ? 'bg-primary text-white' : 'bg-secondary bg-opacity-25 text-light'}`;
            bubble.style.maxWidth = '80%';

            if (isHtml) {
                bubble.innerHTML = content;
            } else {
                bubble.textContent = content;
            }

            div.appendChild(bubble);
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = input.value.trim();
            if (!query) return;

            // Clear welcome message if present
            if (history.querySelector('.text-center')) {
                history.innerHTML = '';
            }

            appendMessage('user', query);
            input.value = '';
            input.disabled = true;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();

                // 1. Show AI Answer if available
                if (data.answer) {
                    const answerHtml = `
                        <div class="mb-3">
                            <h6 class="fw-bold text-info mb-2"><i class="fas fa-robot me-2"></i>Respuesta Inteligente:</h6>
                            <div class="text-light" style="white-space: pre-wrap;">${data.answer}</div>
                        </div>
                        <hr class="border-secondary mb-3">
                     `;
                    appendMessage('bot', answerHtml, true);
                }

                // 2. Show Sources (Snippets)
                if (data.results && data.results.length > 0) {
                    let html = '<h6 class="fw-bold mb-2 small text-muted"><i class="fas fa-search-location me-2"></i>Fuentes utilizadas:</h6>';
                    data.results.forEach(item => {
                        const score = (item.score || 0).toFixed(2);
                        const filename = item.filename || "Desconocido";
                        const docId = item.doc_id || item.id; // Handle both formats
                        const text = item.text || item.snippet || "";

                        // Create a link to the document
                        const link = `/document/${docId}`;
                        html += `
                        <div class="mb-2 p-2 rounded bg-dark border border-secondary border-opacity-25">
                            <div class="d-flex justify-content-between small text-info mb-1">
                                <span><i class="fas fa-file-alt me-1"></i> ${filename}</span>
                                <span class="badge bg-secondary bg-opacity-25">${score}</span>
                            </div>
                            <p class="mb-1 small text-white-50 fst-italic">"...${text.substring(0, 150)}..."</p>
                            <a href="${link}" target="_blank" class="btn btn-xs btn-outline-light py-0" style="font-size: 0.7rem;">Ver documento</a>
                        </div>
                    `;
                    });
                    appendMessage('bot', html, true);
                } else if (!data.answer) {
                    appendMessage('bot', 'No encontré información relevante en los documentos.');
                }

            } catch (err) {
                appendMessage('bot', 'Error al consultar el servicio.');
                console.error(err);
            } finally {
                input.disabled = false;
                input.focus();
            }
        });

        rebuildBtn.addEventListener('click', async () => {
            if (!confirm('Esto puede tardar unos minutos. ¿Desea reindexar todos los documentos?')) return;
            try {
                const res = await fetch('/api/rag/rebuild', { method: 'POST' });
                const data = await res.json();
                alert(data.message);
            } catch (err) {
                alert('Error al iniciar reindexado');
            }
        });
    });
</script>
{% endblock %}