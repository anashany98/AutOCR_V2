{% extends "base.html" %}

{% block title %}Editor - {{ document.filename }}{% endblock %}

{% block content %}
<div class="row mb-4 animate-fade-in">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.documents') }}"
                            class="text-muted text-decoration-none">Documentos</a></li>
                    <li class="breadcrumb-item active text-light" aria-current="page">{{ document.filename }}</li>
                </ol>
            </nav>
            <h1 class="h4 fw-bold mb-0">Revisi贸n y Edici贸n</h1>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-danger" onclick="deleteDocument({{ document.id }})">
                <i class="fas fa-trash-alt"></i>
            </button>
            {% if document.workflow_state != 'verified' %}
            <a href="{{ url_for('main.verify_document', doc_id=document.id) }}" class="btn btn-success">
                <i class="fas fa-edit me-2"></i> Verificar (UI)
            </a>
            {% endif %}
            <button class="btn btn-primary" onclick="saveChanges()">
                <i class="fas fa-save me-2"></i> Guardar
            </button>
        </div>
    </div>
</div>

{% if document.status == 'FAILED' %}
<div class="alert alert-danger mb-4 animate-shake" role="alert">
    <div class="d-flex align-items-center">
        <div class="me-3">
            <i class="fas fa-exclamation-circle fa-2x"></i>
        </div>
        <div>
            <h6 class="alert-heading fw-bold mb-1">El procesamiento de este documento fall贸</h6>
            <p class="mb-0 small">{{ document.error_message or 'Error desconocido durante el procesamiento.' }}</p>
        </div>
    </div>
</div>
{% endif %}

<div class="row g-4 h-100 animate-slide-up">
    <!-- Left Column: Preview -->
    <div class="col-lg-6">
        <div class="card h-100 border-0" style="min-height: 70vh;">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold text-uppercase text-muted small">Vista Previa y Edici贸n</h6>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" id="zoom-out" title="Alejar"><i
                            class="fas fa-search-minus"></i></button>
                    <button class="btn btn-sm btn-outline-secondary" id="zoom-in" title="Acercar"><i
                            class="fas fa-search-plus"></i></button>
                    <button class="btn btn-sm btn-outline-secondary" id="toggle-compare"
                        title="Comparar Original/Mejorado"><i class="fas fa-columns"></i></button>
                    <div class="vr mx-1"></div>
                    <button class="btn btn-sm btn-outline-primary" id="toggle-draw" title="Dibujar Regiones"
                        onclick="toggleDrawingMode()">
                        <i class="fas fa-draw-polygon"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success ms-1" id="save-template"
                        title="Guardar como Plantilla" onclick="saveAsTemplate()">
                        <i class="fas fa-save"></i>
                    </button>
                    <!-- CAD Export Button -->
                    <button class="btn btn-sm btn-outline-warning ms-1" id="export-dxf" title="Exportar a AutoCAD (DXF)"
                        onclick="exportToCAD()">
                        <i class="fas fa-drafting-compass"></i>
                    </button>
                    <!-- Blueprint Analysis Button -->
                    <button class="btn btn-sm btn-outline-primary ms-1" id="analyze-blueprint"
                        title="Analizar Plano (Escala/reas)" onclick="analyzeBlueprint()">
                        <i class="fas fa-ruler-combined"></i>
                    </button>
                    <!-- Proposal Generator Button -->
                    <button class="btn btn-sm btn-outline-danger ms-1" id="gen-proposal" title="Generar Propuesta (PDF)"
                        onclick="generateProposal()">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <!-- Order Export Button -->
                    <button class="btn btn-sm btn-outline-success ms-1" id="gen-order" title="Generar Pedido (Excel)"
                        onclick="generateOrder()">
                        <i class="fas fa-file-excel"></i>
                    </button>
                    <div class="dropdown d-inline-block ms-1">
                        <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button"
                            id="loadTemplateDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                            title="Cargar Plantilla" onclick="loadTemplateList()">
                            <i class="fas fa-file-import"></i>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="loadTemplateDropdown" id="template-list">
                            <li>
                                <h6 class="dropdown-header">Plantillas Disponibles</h6>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item disabled" href="#">Cargando...</a></li>
                        </ul>
                    </div>
                    <a href="{{ url_for('main.view_document_file', doc_id=document.id) }}" target="_blank"
                        class="btn btn-sm btn-outline-secondary ms-1">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>

            <div class="card-body p-0 d-flex flex-column bg-dark bg-opacity-50 rounded-bottom position-relative overflow-hidden"
                style="height: 70vh;">

                <!-- PDF Toolbar (Hidden by default) -->
                <div id="pdf-toolbar"
                    class="bg-secondary bg-opacity-25 p-1 d-none justify-content-center align-items-center gap-2 border-bottom border-secondary">
                    <button class="btn btn-sm btn-link text-light" id="prev-page"><i
                            class="fas fa-chevron-left"></i></button>
                    <span class="small text-muted">P谩g <span id="page-num">1</span> de <span
                            id="page-count">--</span></span>
                    <button class="btn btn-sm btn-link text-light" id="next-page"><i
                            class="fas fa-chevron-right"></i></button>
                </div>

                <!-- Canvas Container -->
                <div id="canvas-container"
                    class="flex-grow-1 overflow-auto position-relative d-flex justify-content-center bg-dark">
                    <canvas id="the-canvas" style="border: 1px solid rgba(255,255,255,0.1); max-width: 100%;"></canvas>
                </div>

                <!-- Loading Overlay -->
                <div id="viewer-loading"
                    class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-75"
                    style="z-index: 10;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Editor -->
    <div class="col-lg-6">
        <div class="card h-100 border-0">
            <div class="card-header bg-transparent border-0">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    {% if document.type == 'Imagen' %}
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#visual-ai"
                            type="button">Inteligencia Visual</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#visual-similar"
                            type="button">Similares</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#metadata"
                            type="button">Metadatos</button>
                    </li>
                    {% if document.text %}
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#edit-ocr" type="button">Extracto
                            OCR</button>
                    </li>
                    {% endif %}
                    {% else %}
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#edit-ocr"
                            type="button">Extracto OCR</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#edit-md"
                            type="button">Markdown</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#metadata"
                            type="button">Metadatos</button>
                    </li>
                    {% if document.type == 'Imagen' or (document.tags and document.tags|length > 0) %}
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#visual-ai"
                            type="button">Inteligencia Visual</button>
                    </li>
                    {% endif %}
                    <!-- Structured Data Tab Hidden by User Request
                    {% if document.type != 'Imagen' and document.structured_data %}
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#structured-data"
                            type="button">Datos Estructurados</button>
                    </li>
                    {% endif %}
                    -->
                    {% endif %}
                </ul>
            </div>
            <div class="card-body">
                <form id="editor-form">
                    <div class="tab-content h-100">
                        <!-- OCR Tab -->
                        <div class="tab-pane fade {{ 'show active' if document.type != 'Imagen' }} h-100" id="edit-ocr">
                            <textarea class="form-control bg-dark text-light border-secondary font-monospace"
                                id="ocr_text" name="ocr_text"
                                style="height: 60vh; resize: none;">{{ document.text }}</textarea>
                        </div>

                        <!-- Markdown Tab -->
                        <div class="tab-pane fade h-100" id="edit-md">
                            <textarea class="form-control bg-dark text-light border-secondary font-monospace"
                                id="markdown_text" name="markdown_text"
                                style="height: 60vh; resize: none;">{{ document.markdown }}</textarea>
                        </div>

                        <!-- Metadata Tab -->
                        <div class="tab-pane fade" id="metadata">
                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">Nombre del Archivo</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary"
                                    value="{{ document.filename }}" readonly>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold">Tipo Documental</label>
                                    <select class="form-select bg-dark text-light border-secondary" name="doc_type">
                                        <option value="Invoice" {{ 'selected' if document.type=='Invoice' }}>factura
                                        </option>
                                        <option value="Receipt" {{ 'selected' if document.type=='Receipt' }}>Recibo
                                        </option>
                                        <option value="Contract" {{ 'selected' if document.type=='Contract' }}>Contrato
                                        </option>
                                        <option value="Report" {{ 'selected' if document.type=='Report' }}>Informe
                                        </option>
                                        <option value="Imagen" {{ 'selected' if document.type=='Imagen' }}>Imagen /
                                            Mueble
                                        </option>
                                        <option value="Unknown" {{ 'selected' if document.type=='Unknown' }}>Desconocido
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold">Estado Workflow</label>
                                    <div class="d-flex align-items-center gap-2">
                                        {% if document.workflow_state == 'verified' %}
                                        <span
                                            class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2 w-100">
                                            <i class="fas fa-check-circle me-1"></i> Verificado
                                        </span>
                                        {% elif document.workflow_state == 'pending' %}
                                        <span
                                            class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 px-3 py-2 w-100">
                                            <i class="fas fa-exclamation-triangle me-1"></i> Pendiente
                                        </span>
                                        {% else %}
                                        <span
                                            class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 px-3 py-2 w-100">
                                            <i class="fas fa-plus-circle me-1"></i> Nuevo
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold">Estado Procesamiento</label>
                                    <select class="form-select bg-dark text-light border-secondary" name="status">
                                        <option value="OK" {{ 'selected' if document.status=='OK' }}>OK</option>
                                        <option value="FAILED" {{ 'selected' if document.status=='FAILED' }}>Fallido
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h6 class="text-muted small fw-bold mb-3">Informaci贸n T茅cnica</h6>
                                <p class="small text-muted mb-1"><i class="fas fa-clock me-2"></i> Procesado: {{
                                    document.datetime }}</p>
                                <p class="small text-muted mb-1"><i class="fas fa-stopwatch me-2"></i> Duraci贸n: {{
                                    "%.2f"|format(document.duration or 0) }}s</p>
                                <p class="small text-muted mb-1"><i class="fas fa-percentage me-2"></i> Confianza Ocr:
                                    {{
                                    "%.2f"|format(document.confidence or 0) }}</p>
                            </div>
                        </div>

                        <!-- Visual AI Tab -->
                        <div class="tab-pane fade {{ 'show active' if document.type == 'Imagen' }}" id="visual-ai">
                            <div class="mb-4">
                                <h6 class="text-muted small fw-bold text-uppercase mb-3">Objetos y Atributos Detectados
                                </h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% set has_tags = false %}
                                    {% for tag in document.tags %}
                                    {% if not tag.startswith('color:') and not tag.startswith('') %}
                                    <span
                                        class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2">
                                        <i class="fas fa-tag me-1"></i> {{ tag }}
                                    </span>
                                    {% set has_tags = true %}
                                    {% endif %}
                                    {% endfor %}
                                    {% if not has_tags %}
                                    <div
                                        class="d-flex flex-column align-items-center justify-content-center py-4 bg-dark bg-opacity-25 rounded-3 border border-secondary border-dashed w-100">
                                        <i class="fas fa-cube text-muted mb-2 opacity-50" style="font-size: 2rem;"></i>
                                        <p class="text-muted small mb-0">No se han detectado objetos espec铆ficos</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="text-muted small fw-bold text-uppercase mb-3">Paleta de Colores Dominantes
                                </h6>
                                <div class="d-flex gap-3 align-items-center">
                                    {% set has_colors = false %}
                                    {% for tag in document.tags %}
                                    {% if tag.startswith('color:') %}
                                    {% set color_hex = tag.replace('color:', '') %}
                                    <div class="text-center">
                                        <div style="width: 50px; height: 50px; background-color: {{ color_hex }};"
                                            class="rounded-circle border border-secondary shadow-sm mb-1"
                                            title="{{ color_hex }}"></div>
                                        <code class="small text-muted" style="font-size: 0.7rem;">{{ color_hex }}</code>
                                    </div>
                                    {% set has_colors = true %}
                                    {% endif %}
                                    {% endfor %}
                                    {% if not has_colors %}
                                    <div
                                        class="d-flex flex-column align-items-center justify-content-center py-4 bg-dark bg-opacity-25 rounded-3 border border-secondary border-dashed w-100">
                                        <i class="fas fa-palette text-muted mb-2 opacity-50"
                                            style="font-size: 2rem;"></i>
                                        <p class="text-muted small mb-0">Paleta no disponible</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div>
                                <h6 class="text-muted small fw-bold text-uppercase mb-3">Sugerencias de Decoraci贸n</h6>
                                <div class="list-group list-group-flush bg-transparent">
                                    {% set has_advice = false %}
                                    {% for tag in document.tags %}
                                    {% if tag.startswith('') %}
                                    <div class="list-group-item bg-transparent border-secondary text-light ps-0">
                                        <i class="fas fa-lightbulb text-warning me-2"></i> {{ tag.replace(' ', '') }}
                                    </div>
                                    {% set has_advice = true %}
                                    {% endif %}
                                    {% endfor %}
                                    {% if not has_advice %}
                                    <div
                                        class="d-flex flex-column align-items-center justify-content-center py-4 bg-dark bg-opacity-25 rounded-3 border border-secondary border-dashed w-100">
                                        <i class="fas fa-lightbulb text-muted mb-2 opacity-50"
                                            style="font-size: 2rem;"></i>
                                        <p class="text-muted small mb-0">Sin sugerencias de decoraci贸n</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Visual Similar Tab -->
                        <div class="tab-pane fade" id="visual-similar">
                            <h6 class="text-muted small fw-bold text-uppercase mb-3">Documentos Similares (B煤squeda
                                Visual)</h6>
                            <div id="similar-list" class="row row-cols-1 row-cols-md-2 g-3">
                                <div class="col-12 text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="text-muted mt-2 small">Buscando coincidencias visuales...</p>
                                </div>
                            </div>
                        </div>


                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    async function deleteDocument(docId) {
        if (!confirm('驴Est谩 seguro de eliminar este documento? Esta acci贸n no se puede deshacer.')) return;
        try {
            const res = await fetch(`/api/document/${docId}`, { method: 'DELETE' });
            const data = await res.json();
            if (res.ok) {
                window.location.href = "{{ url_for('main.documents') }}";
            } else {
                alert('Error al eliminar: ' + data.message);
            }
        } catch (e) {
            alert('Error de conexi贸n');
        }
    }

    async function verifyDocument(docId) {
        try {
            const res = await fetch(`/api/document/${docId}/verify`, { method: 'POST' });
            if (res.ok) {
                location.reload();
            } else {
                const data = await res.json();
                alert('Error al verificar: ' + data.error);
            }
        } catch (e) {
            alert('Error de conexi贸n');
        }
    }

    async function loadSimilar() {
        const container = document.getElementById('similar-list');
        try {
            const res = await fetch(`/api/search/similar/{{ document.id }}`);
            const results = await res.json();

            if (!results.length) {
                container.innerHTML = '<div class="col-12 text-center py-4 text-muted small">No se encontraron documentos visualmente similares.</div>';
                return;
            }

            container.innerHTML = results.map(doc => `
                <div class="col">
                    <div class="card bg-dark border-secondary h-100 overflow-hidden">
                        <a href="/document/${doc.id}" class="text-decoration-none">
                            <img src="/${doc.path}" class="card-img-top" style="height: 120px; object-fit: cover;" onerror="this.src='/static/img/placeholder.png'">
                            <div class="card-body p-2">
                                <p class="card-title text-truncate text-light small mb-1">${doc.filename}</p>
                                <span class="badge bg-secondary" style="font-size: 0.6rem;">Similaridad: ${(doc.score * 100).toFixed(1)}%</span>
                            </div>
                        </a>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            container.innerHTML = '<div class="col-12 text-center py-4 text-danger small">Error al cargar similares.</div>';
        }
    }

    // Load similar items if the tab is shown
    const similarTab = document.querySelector('button[data-bs-target="#visual-similar"]');
    if (similarTab) {
        similarTab.addEventListener('shown.bs.tab', () => {
            loadSimilar();
        });

        // Auto-load if it's an image and initially shown
        if (similarTab.classList.contains('active')) {
            loadSimilar();
        }
    }

    async function saveChanges() {
        const ocrText = document.getElementById('ocr_text').value;
        const mdText = document.getElementById('markdown_text').value;
        const type = document.querySelector('select[name="doc_type"]').value;
        const status = document.querySelector('select[name="status"]').value;

        try {
            const response = await fetch(`/api/document/{{ document.id }}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: ocrText,
                    markdown: mdText,
                    type: type,
                    status: status,
                    corrections: fabricCanvas ? fabricCanvas.getObjects().filter(o => o.type !== 'image') : []
                })
            });

            if (response.ok) {
                // Show toast
                const alert = document.createElement('div');
                alert.className = 'alert alert-success position-fixed top-0 end-0 m-4';
                alert.style.zIndex = 1050;
                alert.innerHTML = '<i class="fas fa-check-circle me-2"></i> Cambios guardados correctamente';
                document.body.appendChild(alert);
                setTimeout(() => alert.remove(), 3000);
            } else {
                alert('Error al guardar los cambios');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi贸n al guardar');
        }
    }

    async function dismissAnomaly(anomaly) {
        try {
            const res = await fetch(`/api/document/{{ document.id }}/dismiss-anomaly`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ anomaly: anomaly })
            });
            if (res.ok) {
                // Remove the anomaly from UI
                const anomalyElement = event.target.closest('li');
                if (anomalyElement) {
                    anomalyElement.remove();
                }
                // If no more anomalies, remove the entire alert
                const anomalyList = document.querySelector('.alert-warning ul');
                if (anomalyList && anomalyList.children.length === 0) {
                    document.querySelector('.alert-warning').remove();
                }
            } else {
                alert('Error al descartar anomal铆a');
            }
        } catch (e) {
            console.error('Error dismissing anomaly:', e);
        }
    }

    let providerSearchTimeout;
    async function searchProviders(query) {
        clearTimeout(providerSearchTimeout);

        if (!query || query.length < 2) {
            document.getElementById('provider-results').innerHTML = '';
            return;
        }

        providerSearchTimeout = setTimeout(async () => {
            try {
                const res = await fetch(`/api/providers/search?q=${encodeURIComponent(query)}`);
                const providers = await res.json();

                const resultsDiv = document.getElementById('provider-results');
                if (!providers.length) {
                    resultsDiv.innerHTML = '<div class="text-muted small">No se encontraron proveedores.</div>';
                    return;
                }

                let html = '<div class="list-group">';
                providers.forEach(provider => {
                    html += `
                        <button type="button" class="list-group-item list-group-item-action bg-dark text-light border-secondary" 
                                onclick="selectProvider('${provider.id}', '${provider.name}')">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${provider.name}</h6>
                                <small class="badge bg-secondary">${provider.category}</small>
                            </div>
                            <small class="text-muted">${provider.vat}</small>
                        </button>
                    `;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
            } catch (e) {
                console.error('Provider search error:', e);
            }
        }, 300); // Debounce
    }

    function selectProvider(providerId, providerName) {
        // Update the vendor field display
        const vendorValue = document.querySelector('.card-body:has(.fa-building) .card-text');
        if (vendorValue) {
            vendorValue.textContent = providerName;
        }

        // Close the search results
        document.getElementById('provider-results').innerHTML = '';
        document.getElementById('provider-search').value = '';

        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success position-fixed top-0 end-0 m-4';
        alert.style.zIndex = 1050;
        alert.innerHTML = `<i class="fas fa-check-circle me-2"></i> Proveedor "${providerName}" seleccionado. Guarda el documento para confirmar.`;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }

    // Image Enhancement Logic
    async function applyEnhancement(mode) {
        const btn = document.getElementById('btn-apply-enhance');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';

        const data = {
            contrast: document.getElementById('contrastRange').value,
            brightness: document.getElementById('brightnessRange').value,
            sharpness: document.getElementById('sharpnessRange').value,
            clahe: document.getElementById('claheCheck').checked
        };

        if (mode === 'auto') {
            data.contrast = 1.2;
            data.brightness = 1.1;
            data.sharpness = 1.5;
            data.clahe = true;
            // Update UI
            document.getElementById('contrastRange').value = 1.2;
            document.getElementById('brightnessRange').value = 1.1;
            document.getElementById('sharpnessRange').value = 1.5;
            document.getElementById('claheCheck').checked = true;
        }

        try {
            const res = await fetch(`/api/document/{{ document.id }}/enhance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (res.ok) {
                alert('Imagen mejorada. La p谩gina se recargar谩 para mostrar el nuevo resultado.');
                window.location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (e) {
            alert('Error de conexi贸n');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Aplicar Cambios';
        }
    }

    // CAD Export Logic
    async function exportToCAD() {
        const btn = document.getElementById('export-dxf');
        const originalIcon = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const res = await fetch(`/api/document/{{ document.id }}/export/dxf`, { method: 'POST' });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "{{ document.filename|replace('.', '_') }}.dxf";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } else {
                const err = await res.json();
                alert('Error al exportar a DXF: ' + (err.error || 'Desconocido'));
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi贸n al exportar.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }
    }
</script>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

<script>
    // Configuration
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const docBaseUrl = "{{ url_for('main.view_document_file', doc_id=document.id) }}";
    let docUrl = docBaseUrl;
    let currentVersion = 'current';

    const isPdf = "{{ document.filename.lower().endswith('.pdf') }}" === "True";
    const existingCorrections = {{ document.structured_data.corrections | tojson | safe if document.structured_data and document.structured_data.corrections else '[]' }};

    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.0;
    let canvas = document.getElementById('the-canvas');
    let ctx = canvas.getContext('2d');
    let fabricCanvas = null;
    let drawingMode = false;

    function loadCorrections() {
        if (!fabricCanvas || !existingCorrections.length) return;

        // Filter corrections for current page if we support multi-page annotations
        // For now, assume global corrections or single page image.
        // If PDF, we might need page-specific logic, but let's start simple.

        fabric.util.enlivenObjects(existingCorrections, function (objects) {
            objects.forEach(function (o) {
                o.selectable = true; // Allow selecting to delete/move
                fabricCanvas.add(o);
            });
            fabricCanvas.renderAll();
        });
    }

    // Initialize Viewer
    async function initViewer() {
        if (isPdf) {
            document.getElementById('pdf-toolbar').classList.remove('d-none');
            document.getElementById('pdf-toolbar').classList.add('d-flex');
            try {
                pdfDoc = await pdfjsLib.getDocument(docUrl).promise;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
                renderPage(pageNum);
            } catch (e) {
                console.error('Error loading PDF:', e);
                alert('Error al cargar PDF');
            }
        } else {
            // It's an image
            const img = new Image();
            img.onload = function () {
                canvas.width = img.width;
                canvas.height = img.height;
                // Fit to container initially
                const container = document.getElementById('canvas-container');
                const ratio = Math.min(container.clientWidth / img.width, container.clientHeight / img.height);
                // We will rely on CSS or Fabric for zoom. For now, draw simple.
                // Better: Use Fabric directly for Image
                initFabricWithImage(img);
                document.getElementById('viewer-loading').classList.add('d-none');
            };
            img.src = docUrl;
        }
    }

    function initFabricWithImage(imgElement) {
        if (fabricCanvas) fabricCanvas.dispose();
        fabricCanvas = new fabric.Canvas('the-canvas', {
            width: imgElement.width,
            height: imgElement.height
        });

        const fImg = new fabric.Image(imgElement);
        fImg.selectable = false;
        fabricCanvas.add(fImg);
        fabricCanvas.setWidth(imgElement.width);
        fabricCanvas.setHeight(imgElement.height);

        // Fit view
        zoomAscpect();
        loadCorrections();
    }

    function zoomAscpect() {
        const container = document.getElementById('canvas-container');
        if (!fabricCanvas) return;
        const ratio = Math.min((container.clientWidth - 20) / fabricCanvas.width, (container.clientHeight - 20) / fabricCanvas.height);
        fabricCanvas.setZoom(ratio);
        fabricCanvas.setWidth(fabricCanvas.width * ratio);
        fabricCanvas.setHeight(fabricCanvas.height * ratio);

        // Ensure corrections are loaded if not already
        // But zoomAscpect is called on resize/zoom too. 
        // We should call loadCorrections ONLY ONCE after init.
        // Let's call it in initFabricWithImage and renderPage instead.
    }

    async function renderPage(num) {
        pageRendering = true;

        // Fetch page
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: scale * 1.5 }); // Higher res render

        // If fabric exists, we need to handle it.
        // For PDF, we render to canvas then create fabric object over it?
        // Or render to hidden canvas and use as background for Fabric.

        // Simplified PDF render for now to standard canvas, then initialize fabric
        // We need a temporary canvas to render PDF
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.height = viewport.height;
        tempCanvas.width = viewport.width;

        const renderContext = {
            canvasContext: tempCtx,
            viewport: viewport
        };

        await page.render(renderContext).promise;

        // Now init fabric with this image
        const imgParams = {
            width: viewport.width,
            height: viewport.height,
            selectable: false
        };

        if (fabricCanvas) fabricCanvas.dispose();
        fabricCanvas = new fabric.Canvas('the-canvas', {
            width: viewport.width,
            height: viewport.height
        });

        // Create fabric image from temp canvas url
        fabric.Image.fromURL(tempCanvas.toDataURL(), function (img) {
            img.selectable = false;
            fabricCanvas.add(img);
            fabricCanvas.sendToBack(img);

            // Adjust zoom to fit container
            zoomAscpect();
            loadCorrections();

            document.getElementById('viewer-loading').classList.add('d-none');
            pageRendering = false;
            if (pageNumPending !== null) {
                renderPage(pageNumPending);
                pageNumPending = null;
            }
        });

        document.getElementById('page-num').textContent = num;
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    // Zoom Controls
    document.getElementById('zoom-in').addEventListener('click', () => {
        if (fabricCanvas) {
            let zoom = fabricCanvas.getZoom();
            zoom *= 1.1;
            fabricCanvas.setZoom(zoom);
            fabricCanvas.setWidth(fabricCanvas.getWidth() * 1.1);
            fabricCanvas.setHeight(fabricCanvas.getHeight() * 1.1);
        }
    });

    document.getElementById('zoom-out').addEventListener('click', () => {
        if (fabricCanvas) {
            let zoom = fabricCanvas.getZoom();
            zoom /= 1.1;
            fabricCanvas.setZoom(zoom);
            fabricCanvas.setWidth(fabricCanvas.getWidth() / 1.1);
            fabricCanvas.setHeight(fabricCanvas.getHeight() / 1.1);
        }
    });

    // PDF Navigation
    document.getElementById('prev-page').addEventListener('click', onPrevPage);
    document.getElementById('next-page').addEventListener('click', onNextPage);

    document.getElementById('toggle-compare').addEventListener('click', () => {
        currentVersion = currentVersion === 'current' ? 'original' : 'current';
        docUrl = docBaseUrl + (currentVersion === 'original' ? '?version=original' : '');

        // Show feedback
        const btn = document.getElementById('toggle-compare');
        if (currentVersion === 'original') {
            btn.classList.add('btn-warning');
            btn.classList.remove('btn-outline-secondary');
            alert('Mostrando ORIGINAL (Solo lectura)');
            // Disable drawing?
        } else {
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-outline-secondary');
            alert('Mostrando MEJORADO');
        }

        initViewer();
    });

    // Drawing Mode
    window.toggleDrawingMode = function () {
        drawingMode = !drawingMode;
        if (!fabricCanvas) return;

        if (drawingMode) {
            fabricCanvas.isDrawingMode = true;
            fabricCanvas.freeDrawingBrush.width = 3;
            fabricCanvas.freeDrawingBrush.color = "rgba(255, 0, 0, 0.5)"; // Red highlight
            document.getElementById('toggle-draw').classList.add('active');
        } else {
            fabricCanvas.isDrawingMode = false;
            document.getElementById('toggle-draw').classList.remove('active');
        }
    };

    // Handle Window Resize
    window.addEventListener('resize', () => {
        if (fabricCanvas) zoomAscpect();
    });

    // Template Management
    async function saveAsTemplate() {
        if (!fabricCanvas) return;
        const objects = fabricCanvas.getObjects().filter(o => o.type !== 'image');
        if (!objects.length) {
            alert('Dibuja al menos una zona antes de guardar.');
            return;
        }

        const name = prompt("Nombre de la plantilla:");
        if (!name) return;

        try {
            const res = await fetch('/api/templates/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    description: "Creada desde el editor visual",
                    zones: objects
                })
            });
            const data = await res.json();
            if (data.success) {
                alert('Plantilla guardada correctamente.');
            } else {
                alert('Error al guardar: ' + data.error);
            }
        } catch (e) {
            console.error(e);
            alert('Error al conectar con el servidor.');
        }
    }

    async function loadTemplateList() {
        const list = document.getElementById('template-list');
        try {
            const res = await fetch('/api/templates');
            const templates = await res.json();

            let html = '<li><h6 class="dropdown-header">Plantillas Disponibles</h6></li><li><hr class="dropdown-divider"></li>';
            if (templates.length === 0) {
                html += '<li><a class="dropdown-item disabled" href="#">No hay plantillas</a></li>';
            } else {
                templates.forEach(t => {
                    // Store zones in data attribute or use ID to fetch? 
                    // Storing in data attribute might be large.
                    // Let's escape it carefully or use simple ID and find in array.
                    // But here we need to pass zones to applyTemplate.
                    // Let's use a global map or just embedded JSON.
                    const zonesStr = t.zones_json.replace(/"/g, '&quot;');
                    html += `<li><a class="dropdown-item" href="#" onclick='applyTemplate(${JSON.stringify(t.zones_json)})'>${t.name}</a></li>`;
                });
            }
            list.innerHTML = html;
        } catch (e) {
            list.innerHTML = '<li><a class="dropdown-item disabled" href="#">Error al cargar</a></li>';
        }
    }

    window.applyTemplate = function (zones) {
        if (!fabricCanvas) return;
        // Parse if string
        if (typeof zones === 'string') {
            try { zones = JSON.parse(zones); } catch (e) { console.error(e); return; }
        }

        if (confirm("驴Aplicar plantilla? Esto agregar谩 las zonas a las existentes.")) {
            fabric.util.enlivenObjects(zones, function (objects) {
                objects.forEach(function (o) {
                    o.selectable = true;
                    fabricCanvas.add(o);
                });
                fabricCanvas.renderAll();
            });
        }
    };

    async function generateOrder() {
        const btn = document.getElementById('gen-order');
        const originalIcon = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const res = await fetch(`/api/document/{{ document.id }}/generate_order`, { method: 'POST' });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Pedido_{{ document.filename|replace('.', '_') }}.xlsx";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                alert('Hoja de pedido generada con 茅xito.');
            } else {
                const err = await res.json();
                alert('Error al generar pedido: ' + (err.error || 'Desconocido'));
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi贸n al generar pedido.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }
    }

    async function analyzeBlueprint() {
        const btn = document.getElementById('analyze-blueprint');
        const originalIcon = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const res = await fetch(`/api/document/{{ document.id }}/interpret_blueprint`, { method: 'POST' });
            if (res.ok) {
                const data = await res.json();

                // Populate Modal
                document.getElementById('bp-scale').textContent = data.scale || 'No detectada';

                const roomsList = document.getElementById('bp-rooms');
                roomsList.innerHTML = '';
                if (data.rooms && data.rooms.length > 0) {
                    data.rooms.forEach(room => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = room;
                        roomsList.appendChild(li);
                    });
                } else {
                    roomsList.innerHTML = '<li class="list-group-item text-muted">No detectadas</li>';
                }

                const areasList = document.getElementById('bp-areas');
                areasList.innerHTML = '';
                if (data.areas && data.areas.length > 0) {
                    data.areas.forEach(area => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = area;
                        areasList.appendChild(li);
                    });
                } else {
                    areasList.innerHTML = '<li class="list-group-item text-muted">No detectadas</li>';
                }

                // Show Modal
                const modal = new bootstrap.Modal(document.getElementById('blueprintModal'));
                modal.show();
            } else {
                const err = await res.json();
                alert('Error al analizar plano: ' + (err.error || 'Desconocido'));
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi贸n al analizar plano.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }
    }

    async function generateProposal() {
        const btn = document.getElementById('gen-proposal');
        const originalIcon = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const res = await fetch(`/api/document/{{ document.id }}/generate_proposal`, { method: 'POST' });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Propuesta_{{ document.filename|replace('.', '_') }}.pdf";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                // Show success toast
                alert('Propuesta generada con 茅xito.');
            } else {
                const err = await res.json();
                alert('Error al generar propuesta: ' + (err.error || 'Desconocido'));
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi贸n al generar propuesta.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }
    }
    async function exportToCAD() {
        const btn = document.getElementById('export-dxf');
        const originalIcon = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const res = await fetch(`/api/document/{{ document.id }}/export_dxf`, { method: 'POST' });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Plano_{{ document.filename|replace('.', '_') }}.dxf";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                alert('Archivo DXF generado y descargado.');
            } else {
                const err = await res.json();
                alert('Error al exportar a CAD: ' + (err.error || 'Desconocido'));
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi贸n al exportar.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }
    }

    document.addEventListener('DOMContentLoaded', initViewer);
</script>



<!-- Enhancement Modal -->
<div class="modal fade" id="enhanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-magic me-2 text-warning"></i>Reparar Escaneo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4 text-center">
                    <button class="btn btn-warning w-100" onclick="applyEnhancement('auto')">
                        <i class="fas fa-wand-magic-sparkles me-2"></i> Auto-Fix (Recomendado)
                    </button>
                    <small class="text-muted d-block mt-2">Aplica contraste adaptativo y nitidez
                        autom谩ticamente.</small>
                </div>

                <hr class="border-secondary">

                <h6 class="mb-3">Ajuste Manual</h6>

                <label class="form-label small">Contraste</label>
                <input type="range" class="form-range" id="contrastRange" min="0.5" max="2.0" step="0.1" value="1.0">

                <label class="form-label small mt-2">Brillo</label>
                <input type="range" class="form-range" id="brightnessRange" min="0.5" max="2.0" step="0.1" value="1.0">

                <label class="form-label small mt-2">Nitidez</label>
                <input type="range" class="form-range" id="sharpnessRange" min="0.0" max="3.0" step="0.5" value="1.0">

                <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" id="claheCheck">
                    <label class="form-check-label" for="claheCheck">Correcci贸n de Iluminaci贸n (CLAHE)</label>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-apply-enhance"
                    onclick="applyEnhancement('manual')">
                    Aplicar Cambios
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}